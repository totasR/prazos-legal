function calculate() {
    // 1. OBTER INPUTS
    const procType = document.getElementById('proc').value;
    const dateNotifStr = document.getElementById('date_notif').value;
    const diasPrazoBase = parseInt(document.getElementById('prazo').value) || 1;
    const isUrgente = document.getElementById('urg').checked;

    if (!dateNotifStr) {
        document.getElementById('result').innerHTML = `<p style="color: red;">Por favor, selecione uma data para o ato.</p>`;
        return;
    }

    const dataEfetiva = parseDate(dateNotifStr);

    // 2. CALCULAR DILA√á√ÉO E PRAZO TOTAL
    const diasDilacao = calculateDilacao();
    const prazoTotal = diasPrazoBase + diasDilacao;

    // --- In√≠cio da L√≥gica Corrigida ---

    let dataFinal;
    let calculationMode;
    
    // Identificar o caso especial do Processo Penal n√£o urgente
    const isPenalNaoUrgente = (procType === 'Penal' && !isUrgente);

    if (isPenalNaoUrgente) {
        // 3. REGIME PENAL N√ÉO URGENTE: Contagem cont√≠nua com transfer√™ncia do termo
        calculationMode = `PENAL (N√ÉO URGENTE) - Contagem cont√≠nua (dias corridos), com transfer√™ncia do termo para o 1¬∫ dia √∫til seguinte.`;

        // A contagem √© cont√≠nua, basta somar os dias corridos ao dia seguinte ao do ato.
        // O prazo come√ßa a contar-se no dia seguinte ao da notifica√ß√£o.
        let diaDePartida = new Date(dataEfetiva);
        dataFinal = addDays(diaDePartida, prazoTotal); // Soma direta dos dias
        
        // Agora, verifica se o termo calha em dia n√£o √∫til e transfere se necess√°rio.
        // Para a transfer√™ncia, as f√©rias contam como dia n√£o √∫til, por isso isUrgente=false.
        while (!isBusinessDay(dataFinal, false)) { 
            dataFinal = addDays(dataFinal, 1);
        }

    } else {
        // 4. REGIME GERAL (C√≠vel, Admin, Penal Urgente): Contagem em dias √∫teis
        let diaDePartida = new Date(dataEfetiva);
        let prazoCount = 0;

        // A contagem do prazo (dila√ß√£o + perempt√≥rio) √© em dias √∫teis.
        while (prazoCount < prazoTotal) {
            diaDePartida = addDays(diaDePartida, 1);
            if (isBusinessDay(diaDePartida, isUrgente)) {
                prazoCount++;
            }
        }
        dataFinal = diaDePartida;

        // 4.1 APLICAR REGIME DE URG√äNCIA (AUJ n¬∫ 1/2021) para estes casos
        if (isUrgente) {
            calculationMode = `URGENTE (AUJ n¬∫ 1/2021) - Cont√≠nuo, n√£o suspende em f√©rias e o termo N√ÉO se transfere.`;
            // Nenhuma a√ß√£o necess√°ria, a data final √© a que foi calculada.
        } else {
            calculationMode = `N√ÉO URGENTE (CPC/CPTA) - Contagem em dias √∫teis, com suspens√£o em f√©rias e transfer√™ncia do termo.`;
            // Em processo n√£o urgente, se o termo cair em dia n√£o √∫til, transfere-se.
            while (!isBusinessDay(dataFinal, isUrgente)) {
                dataFinal = addDays(dataFinal, 1);
            }
        }
    }
    
    // --- Fim da L√≥gica Corrigida ---

    // 5. CALCULAR PRAZO DE GRA√áA (Esta l√≥gica mant√©m-se, pois parte da dataFinal j√° corrigida)
    const gracePeriod = [];
    let lastDay = new Date(dataFinal);
    let graceCount = 0;
    while (graceCount < 3) {
        lastDay = addDays(lastDay, 1);
        if (isBusinessDay(lastDay, isUrgente)) { // A contagem de dias de gra√ßa √© sempre em dias √∫teis
            graceCount++;
            gracePeriod.push(lastDay);
        }
    }

    // 6. APRESENTAR RESULTADOS
    let resultHTML = `
        <p><span class="date-label">üîî Data Efetiva do Ato:</span> <span class="date-value">${formatDate(dataEfetiva)}</span></p>
        <p><span class="date-label">‚ûï Dila√ß√£o Calculada (Art. 245¬∫ CPC):</span> <span class="info-value">${diasDilacao} dias</span></p>
        <p><span class="date-label">‚è≥ Prazo Total (Perempt√≥rio + Dila√ß√£o):</span> <span class="info-value">${prazoTotal} dias</span></p>
        <p><span class="date-label">‚è∞ Termo do Prazo Perempt√≥rio:</span> <span class="date-value">${formatDate(dataFinal)}</span></p>

        <div class="grace-period">
            <p><span class="date-label">‚ú® Prazo de Gra√ßa (com multa):</span></p>
            <p>1¬∫ Dia: <span class="date-value">${formatDate(gracePeriod[0])}</span></p>
            <p>2¬∫ Dia: <span class="date-value">${formatDate(gracePeriod[1])}</span></p>
            <p>3¬∫ Dia: <span class="date-value">${formatDate(gracePeriod[2])}</span></p>
        </div>

        <div class="calculation-mode">
            <strong>Modo de Contagem:</strong> ${calculationMode}
        </div>
    `;
    document.getElementById('result').innerHTML = resultHTML;
}
